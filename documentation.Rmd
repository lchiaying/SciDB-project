---
title: "SciDB"
author: "Wusuo Liu and Chia Ying Lee"
date: "5/3/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Installation

Download the virtual machine from <insert Google Docs URL>.

Full documentation of SciDB is provided [here](https://paradigm4.atlassian.net/wiki/display/ESD/SciDB+Documentation).

The `scidb` R package is available on [CRAN](https://cran.r-project.org/package=scidb), along with [documentation](https://cran.r-project.org/web/packages/scidb/vignettes/scidb.pdf).

The virtual machine has R and RStudio server already set up with `scidb` R package installed. (Note the pre-installed version of `scidb` is not the latest version.)

# SciDB query

Uses the AFL query language blah blah blah.

# Basics of SciDB R package

First, load the library, and connect to the SciDB database.
```{r}
library(scidb, quietly = T)
scidbconnect()
```

The VM's SciDB database already contains several datasets. We can list them.
```{r}
scidblist()
```

To build a new dataset in the database, we use the `build` function to create an AFL query expression, then `scidbeval` to evaluate it into an actual SciDB data object. 

As an example, we create a sparse matrix as follows:

```{r}
x <- build("<v:double>[i=1:2,2,0, j=1:3,1,0], i*j)", dim = c(3,4))
scidbeval(x, name = "test") # Give the dataset a meaningful name
```

Now the matrix is in the SciDB database. Let's load it into R as a `scidb` object.
```{r}
x.scidb <- scidb("test") # Retrieve the dataset by its name
print(x.scidb)
```


# Data

## Download data

We use the movie ratings data from [MovieLens](https://grouplens.org/datasets/movielens/).


```{r}
# Get the small dataset
data.dir <- "ml-latest-small"
if (!dir.exists(data.dir)) {
  download.file("http://files.grouplens.org/datasets/movielens/ml-latest-small.zip", 
                destfile = "ml-20m.zip")
  unzip("ml-20m.zip")
}
```


## Load Data into R

```{r}
library(data.table, quietly = T)
library(Matrix, quietly = T)

# ratings <- read.csv("ml-latest-small/ratings.csv")
# ratings <- as.scidb(ratings[,-4]) # gives error

links <- read.csv("ml-latest-small/links.csv")
links <- as.scidb(links) # OK

```


```{r}
# mat <- scidb("mat")
# 
# source("vm_functions.R")
# image(mat, grid = c(10,10)) -> Im
```


```
AFL% CREATE ARRAY ratings <userId:int64, movieID:int64, rating:double, timestamp:int64> [i=1:700,1000000,0]
AFL% load(ratings, '/home/scidb/Project/ml-latest-small/ratings_0.csv', -2, 'csv');
AFL% store(redimension(ratings, <val:double>[userId=1:*,?,0,movieID=1:*,?,0]), ratings_matrix);
```